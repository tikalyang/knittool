<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‰¤é‡ç¹”åœ–å…¨èƒ½ç”Ÿæˆå™¨ - v3.5</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #fdf2f2; color: #4a4a4a; padding: 20px; display: flex; flex-direction: column; align-items: center; line-height: 1.5; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 650px; width: 100%; }
        h2 { color: #d63384; text-align: center; margin-bottom: 5px; }
        .author { text-align: center; font-size: 12px; color: #aaa; margin-bottom: 20px; }
        
        /* é‡æ³•å¡ç‰‡ */
        .legend-card { background: #fffafb; border: 2px solid #f8d7da; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px; }
        .code-tag { background: #d63384; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-family: monospace; margin-right: 5px; }

        /* è¼¸å…¥æ§åˆ¶å€ */
        .input-group { display: flex; flex-direction: column; gap: 12px; border-top: 1px solid #eee; padding-top: 20px; }
        .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 5px; }
        .row label { flex: 1; min-width: 100px; font-weight: bold; font-size: 14px; }
        input, select { flex: 2; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .checkbox-row { display: flex; align-items: center; gap: 10px; background: #fff3f5; padding: 12px; border-radius: 8px; border: 1px dashed #d63384; }
        .btn-generate { background-color: #d63384; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; margin-top: 10px; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        #capture-area { background: white; padding: 10px; margin-top: 20px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #f8d7da; padding: 10px 5px; text-align: center; font-size: 14px; }
        th { background-color: #fff0f3; color: #d63384; }
        .done-row { background-color: #f2f2f2 !important; color: #aaa; text-decoration: line-through; }
        .highlight-row { background-color: #fff9c4; font-weight: bold; }
        
        /* èª¿æ•´æŒ‰éˆ• */
        .edit-btns { display: flex; gap: 4px; justify-content: center; }
        .btn-edit { border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; }
        .btn-add { background: #e3f2fd; color: #1976d2; }
        .btn-del { background: #ffebee; color: #c62828; }

        .action-btns { display: flex; gap: 10px; margin-top: 15px; width: 100%; }
        .btn-action { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-copy-img { background: #28a745; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ§¶ é‰¤é‡ç¹”åœ–å…¨èƒ½ç”Ÿæˆå™¨</h2>
    <p class="author">å…¨åŠŸèƒ½å¤§æ•´åˆ v3.5 | æ”¯æ´å½¢ç‹€é¸æ“‡èˆ‡è‡ªç”±å¢æ¸›</p>

    <div class="legend-card">
        <div class="legend-grid">
            <div><span class="code-tag">X</span> çŸ­é‡</div>
            <div><span class="code-tag">V</span> åŠ é‡</div>
            <div><span class="code-tag">A</span> æ¸›é‡</div>
            <div><span class="code-tag">MR</span> ç’°ç‹€èµ·é‡</div>
        </div>
    </div>

    <div class="input-group">
        <div class="row">
            <label>ç’°ç‹€èµ·é‡æ•¸:</label>
            <select id="mrBase">
                <option value="4">4 é‡</option>
                <option value="5">5 é‡</option>
                <option value="6" selected>6 é‡</option>
                <option value="8">8 é‡</option>
            </select>
        </div>
        <div class="row">
            <label>éƒ¨ä½å½¢ç‹€:</label>
            <select id="shape">
                <option value="normal">æ¨™æº–çƒé«” / é•·æ©¢åœ“</option>
                <option value="teardrop">æ°´æ»´ç‹€ (ä¸Šå°–ä¸‹åœ“)</option>
            </select>
        </div>
        <div class="row">
            <label>æœ€å¤§ç›´å¾‘ (cm):</label>
            <input type="number" id="diameter" value="5" step="0.1">
        </div>
        <div class="row">
            <label>ç¸½é•·åº¦ (cm):</label>
            <input type="number" id="length" value="5" step="0.1">
        </div>
        <div class="checkbox-row">
            <input type="checkbox" id="keepOpen" onchange="document.getElementById('stopGroup').style.display = this.checked ? 'flex' : 'none'">
            <label for="keepOpen" style="color:#d63384;"><b>éœ€è¦ç¸«åˆæ­¤éƒ¨ä½</b> (è‡ªå‹•åŠ æ’/ä¿ç•™é–‹å£)</label>
        </div>
        <div id="stopGroup" class="row" style="display:none;">
            <label>åœæ­¢æ–¼å¹¾é‡:</label>
            <input type="number" id="stopStitches" value="12">
        </div>
        <button class="btn-generate" onclick="generate()">ç”Ÿæˆç¹”åœ–</button>
    </div>

    <div id="capture-area">
        <table id="pattern-table" style="display:none;">
            <thead>
                <tr>
                    <th width="30">å®Œ</th>
                    <th width="40">åœˆ</th>
                    <th>é‡æ³•é‚è¼¯</th>
                    <th width="50">ç¸½é‡</th>
                    <th width="90">èª¿æ•´</th>
                </tr>
            </thead>
            <tbody id="pattern-body"></tbody>
        </table>
    </div>
    
    <div id="action-btns-area" class="action-btns" style="display:none;">
        <button class="btn-action btn-copy-img" onclick="copyTableAsImage()">ğŸ“‹ è¤‡è£½ç¹”åœ–åœ–ç‰‡</button>
    </div>
</div>

<script>
function renumberRounds() {
    const rows = document.querySelectorAll('#pattern-body tr');
    rows.forEach((row, index) => { row.cells[1].innerText = index + 1; });
}

function toggleRow(checkbox) {
    checkbox.closest('tr').classList.toggle('done-row', checkbox.checked);
}

function addRowAfter(btn) {
    const currentRow = btn.closest('tr');
    const currentSt = currentRow.cells[3].innerText;
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="checkbox" onchange="toggleRow(this)"></td>
        <td></td>
        <td>${currentSt}X <small>(è‡ªè¨‚è¿½åŠ )</small></td>
        <td>${currentSt}</td>
        <td class="edit-btns">
            <button class="btn-edit btn-add" onclick="addRowAfter(this)">â•</button>
            <button class="btn-edit btn-del" onclick="delRow(this)">âŒ</button>
        </td>`;
    currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
    renumberRounds();
}

function delRow(btn) {
    if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ä¸€åœˆå—ï¼Ÿ')) {
        btn.closest('tr').remove();
        renumberRounds();
    }
}

function createRowHTML(logic, st, isExtra = false) {
    return `
        <tr class="${isExtra ? 'highlight-row' : ''}">
            <td><input type="checkbox" onchange="toggleRow(this)"></td>
            <td></td>
            <td>${logic}</td>
            <td>${st}</td>
            <td class="edit-btns">
                <button class="btn-edit btn-add" onclick="addRowAfter(this)">â•</button>
                <button class="btn-edit btn-del" onclick="delRow(this)">âŒ</button>
            </td>
        </tr>`;
}

function generate() {
    const base = parseInt(document.getElementById('mrBase').value);
    const shape = document.getElementById('shape').value;
    const D = parseFloat(document.getElementById('diameter').value);
    const L = parseFloat(document.getElementById('length').value);
    const keepOpen = document.getElementById('keepOpen').checked;
    const stopSt = parseInt(document.getElementById('stopStitches').value);
    
    if (isNaN(D) || D <= 0) return;
    const targetRounds = Math.round(D); 
    const maxSt = targetRounds * base;
    const tbody = document.getElementById('pattern-body');
    tbody.innerHTML = '';
    let rowsHTML = [];

    // 1. åŠ é‡
    rowsHTML.push(createRowHTML(`MR (${base}X)`, base));
    for (let i = 2; i <= targetRounds; i++) {
        let logic = (i === 2) ? `${base}V` : `(${i-2}X, V) * ${base}`;
        rowsHTML.push(createRowHTML(logic, i * base));
    }

    // 2. å›ºå®šå±¤
    let midRounds = (shape === 'normal') ? (L === D ? Math.round(targetRounds * 0.8) : Math.round((L - D) * 2.2)) : 1;
    midRounds = Math.max(1, midRounds);
    if (keepOpen) midRounds += 2;

    for(let i=0; i<midRounds; i++) {
        let isExtra = (keepOpen && i >= (midRounds - 2));
        let logic = maxSt + "X";
        if (isExtra) logic += `<br><small>(ç¸«åˆåŠ å¼·æ’)</small>`;
        rowsHTML.push(createRowHTML(logic, maxSt, isExtra));
    }

    // 3. æ¸›é‡
    if (shape === 'normal') {
        for (let i = targetRounds; i >= 2; i--) {
            let nextSt = (i - 1) * base;
            if (keepOpen && nextSt < stopSt) break;
            let logic = (i === 2) ? `${base}A` : `(${i-2}X, A) * ${base}`;
            rowsHTML.push(createRowHTML(logic, nextSt));
            if (keepOpen && nextSt === stopSt) break;
        }
    } else {
        let curS = maxSt;
        let scount = rowsHTML.length;
        while (curS > base) {
            if (keepOpen && (curS - base) < stopSt) break;
            if (scount % 2 === 0) {
                let k = curS / base;
                rowsHTML.push(createRowHTML(`(${k-2}X, A) * ${base}`, curS - base));
                curS -= base;
            } else {
                rowsHTML.push(createRowHTML(curS + "X", curS));
            }
            scount++;
            if (keepOpen && curS === stopSt) break;
        }
    }

    tbody.innerHTML = rowsHTML.join('');
    document.getElementById('pattern-table').style.display = 'table';
    document.getElementById('action-btns-area').style.display = 'flex';
    renumberRounds();
}

async function copyTableAsImage() {
    const element = document.getElementById('capture-area');
    const canvas = await html2canvas(element);
    canvas.toBlob(blob => {
        const item = new ClipboardItem({ "image/png": blob });
        navigator.clipboard.write([item]);
        alert('å¸¶æœ‰å¢æ¸›è¨­å®šçš„ç¹”åœ–å·²è¤‡è£½ï¼');
    });
}
</script>
</body>
</html>
